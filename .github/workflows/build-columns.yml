# .github/workflows/build-columns.yml

# ... (中略) ...

    steps:
      # ステップ 1: リポジトリのコードをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ 2: Node.js の環境をセットアップ
# ... (中略) ...

      # ステップ 3: 依存関係をインストール
      - name: Install dependencies
        run: npm install
        
      # ===============================================
      # ▼▼▼ 新しい処理: 最新情報 (information/index.json) の生成 ▼▼▼
      # ===============================================

      # ステップ 4: 最新情報生成スクリプトを安全に書き出し、実行する
      - name: Create and Run information JSON build
        run: |
          # 1. スクリプトの内容をヒアドキュメントで安全に書き出す
          #    （実行環境のシェルに依存しない、より安全な方法）
          cat << 'END_OF_SCRIPT' > build-information.mjs
          import { createClient } from 'microcms-js-sdk';
          import fs from 'fs';
          import path from 'path';

          // 環境変数からAPI情報を取得
          const SERVICE_DOMAIN = process.env.MICROCMS_SERVICE_DOMAIN; 
          const API_KEY = process.env.MICROCMS_API_KEY; 
          const API_ENDPOINT = 'information'; 

          const client = createClient({ serviceDomain: SERVICE_DOMAIN, apiKey: API_KEY });
          
          const fetchData = async () => {
            try {
              const data = await client.get({ endpoint: API_ENDPOINT, queries: { limit: 5 } });
              
              const outputDir = path.join(process.cwd(), API_ENDPOINT); 
              const outputPath = path.join(outputDir, 'index.json');
              
              if (!fs.existsSync(outputDir)) {
                fs.mkdirSync(outputDir, { recursive: true });
              }
              
              fs.writeFileSync(outputPath, JSON.stringify(data.contents, null, 2));
              
              console.log(`✅ Success: Generated ${outputPath} with ${data.contents.length} items.`);
              
            } catch (err) {
              console.error('❌ Failed to fetch information microCMS data:', err);
              // ここで exit(1) を呼び出さないことで、コラムのビルド(Step 6)を続行させる
            }
          };

          fetchData();
          END_OF_SCRIPT
          
          # 2. スクリプトの実行 (.mjs で ES Module として明示的に実行)
          #    （npm pkg set type="module" の設定は不要）
          node build-information.mjs

      # ===============================================
      # ▲▲▲ 新しい処理の追加完了 (ステップ 4 と 5 を統合) ▲▲▲
      # ===============================================

      # ステップ 6: 既存のビルドスクリプトを実行 (SSG - コラム生成)
      - name: Run existing build script (Columns SSG)
# ... (中略) ...

      # ステップ 7: GitHub Pages へデプロイ
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Deploy: Build static pages (auto-generated)"
          exclude_assets: |
            .github/
            scripts/
            node_modules/
            package.json
            package-lock.json
            .gitignore
            build-information.mjs # 拡張子を .mjs に変更
