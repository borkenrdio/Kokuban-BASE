name: Build and Deploy SSG Contents

on:
  repository_dispatch:
    types: [microcms-webhook]
  push:
    branches: [main]
    paths-ignore:
      - 'information/**'
      - 'columns/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install microcms-js-sdk

      # ===== information サービス（information.microcms.io） =====
      - name: Run information JSON build
        run: |
          cat > build-information.mjs << 'EOF'
          import { createClient } from 'microcms-js-sdk';
          import fs from 'fs';
          import path from 'path';

          const SERVICE_DOMAIN = (process.env.MICROCMS_INFO_DOMAIN || '').trim();
          const API_KEY = (process.env.MICROCMS_INFO_KEY || '').trim();
          const API_ENDPOINT = 'information';

          if (!SERVICE_DOMAIN || !API_KEY) {
            console.error('Missing environment variables for information service.');
            process.exit(1);
          }

          console.log(`info-env: domain=${SERVICE_DOMAIN}, keyLen=${API_KEY.length}`);

          const client = createClient({ serviceDomain: SERVICE_DOMAIN, apiKey: API_KEY });

          const main = async () => {
            try {
              const data = await client.getList({ endpoint: API_ENDPOINT, queries: { limit: 5 } });
              const outDir = path.join(process.cwd(), 'information');
              const outPath = path.join(outDir, 'index.json');
              if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
              fs.writeFileSync(outPath, JSON.stringify(data.contents, null, 2));
              console.log(`✅ Success: Generated ${outPath} with ${data.contents.length} items.`);
            } catch (err) {
              console.error('❌ Failed to fetch from information microCMS:', err.message);
              process.exit(1);
            }
          };
          main();
          EOF

          node build-information.mjs
        env:
          # ← ドメインは固定値でOK（別サービスなので kokubanbase とは別）
          MICROCMS_INFO_DOMAIN: information
          # ← 既存のシークレットをそのまま使う
          MICROCMS_INFO_KEY: ${{ secrets.MICROCMS_INFORMATION_KEY }}

      # ===== columns/news サービス（kokubanbase.microcms.io） =====
      - name: Run Columns SSG
        run: node scripts/fetch_and_build.mjs
        env:
          MICROCMS_SERVICE_DOMAIN: ${{ secrets.MICROCMS_SERVICE_DOMAIN }} # = kokubanbase
          MICROCMS_API_KEY: ${{ secrets.MICROCMS_COLUMNS_KEY }}

      # ▼▼▼ 【追加】HTML内のプレースホルダーを実際のSecretsに置換 ▼▼▼
      - name: Replace placeholders in generated HTML
        run: |
          # findコマンドでサブディレクトリを含むすべての.htmlファイルを検索して置換
          find . -name "*.html" -type f -exec sed -i 's|{{MICROCMS_SERVICE_DOMAIN}}|${{ secrets.MICROCMS_SERVICE_DOMAIN }}|g' {} +
          find . -name "*.html" -type f -exec sed -i 's|{{MICROCMS_API_KEY}}|${{ secrets.MICROCMS_COLUMNS_KEY }}|g' {} +
          
          echo "Replacement complete."

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "Deploy: Build static pages (auto-generated)"
          exclude_assets: |
            .github/
            scripts/
            node_modules/
            package.json
            package-lock.json
            .gitignore
            build-information.mjs
